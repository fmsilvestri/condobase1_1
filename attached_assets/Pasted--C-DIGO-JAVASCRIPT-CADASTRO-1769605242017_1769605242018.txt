// ================================================================
// CÃ“DIGO JAVASCRIPT - CADASTRO DE MEMBROS DA EQUIPE
// Copie este cÃ³digo para o seu arquivo no Replit
// ================================================================

// ============================================================
// FUNÃ‡ÃƒO PARA CADASTRAR MEMBRO DA EQUIPE
// ============================================================

async function cadastrarMembroEquipe(formData) {
  try {
    // ValidaÃ§Ãµes bÃ¡sicas
    if (!formData.nome || !formData.cpf || !formData.funcao) {
      throw new Error('Nome, CPF e FunÃ§Ã£o sÃ£o obrigatÃ³rios');
    }

    // Formatar CPF (remover pontos e traÃ§os se necessÃ¡rio)
    const cpfFormatado = formData.cpf.replace(/[^\d]/g, '');
    if (cpfFormatado.length !== 11) {
      throw new Error('CPF invÃ¡lido. Deve conter 11 dÃ­gitos');
    }

    // Preparar dados com nomes corretos das colunas (snake_case)
    const dadosParaInserir = {
      nome: formData.nome.toUpperCase(),
      cpf: formData.cpf, // Manter formato original (com pontos e traÃ§os)
      funcao: formData.funcao,
      departamento: formData.departamento || null,
      status: formData.status || 'ativo',
      telefone: formData.telefone || null,
      whatsapp: formData.whatsapp || null,
      email: formData.email || null,
      horario_trabalho: formData.horarioTrabalho || null,
      data_contratacao: formData.dataContratacao || null,
      observacoes: formData.observacoes || null,
      condominium_id: formData.condominiumId || null
    };

    console.log('ğŸ“¤ Enviando dados para Supabase:', dadosParaInserir);

    // Inserir no Supabase
    const { data, error } = await supabase
      .from('membros_equipe')
      .insert([dadosParaInserir])
      .select();

    // Verificar erros
    if (error) {
      console.error('âŒ Erro do Supabase:', error);
      
      // Mensagens de erro mais amigÃ¡veis
      if (error.code === '23505') {
        throw new Error('Este CPF jÃ¡ estÃ¡ cadastrado no sistema');
      } else if (error.code === '23502') {
        throw new Error('Campos obrigatÃ³rios nÃ£o preenchidos');
      } else if (error.message.includes('violates check constraint')) {
        throw new Error('Dados invÃ¡lidos. Verifique o formato do CPF e outros campos');
      } else {
        throw new Error(error.message || 'Erro ao cadastrar membro');
      }
    }

    console.log('âœ… Membro cadastrado com sucesso:', data);
    return { sucesso: true, dados: data[0] };

  } catch (erro) {
    console.error('âŒ Erro ao cadastrar membro:', erro);
    return { sucesso: false, erro: erro.message };
  }
}

// ============================================================
// EXEMPLO DE USO COM FORMULÃRIO HTML
// ============================================================

document.getElementById('formNovoMembro')?.addEventListener('submit', async (event) => {
  event.preventDefault();

  // Pegar valores do formulÃ¡rio
  const formData = {
    nome: document.getElementById('nome').value,
    cpf: document.getElementById('cpf').value,
    funcao: document.getElementById('funcao').value,
    departamento: document.getElementById('departamento').value,
    status: document.getElementById('status').value,
    telefone: document.getElementById('telefone').value,
    whatsapp: document.getElementById('whatsapp').value,
    email: document.getElementById('email').value,
    horarioTrabalho: document.getElementById('horario_trabalho').value,
    dataContratacao: document.getElementById('data_contratacao').value,
    observacoes: document.getElementById('observacoes').value,
    condominiumId: document.getElementById('condominium_id')?.value
  };

  // Desabilitar botÃ£o e mostrar loading
  const btnSubmit = event.target.querySelector('button[type="submit"]');
  const textoOriginal = btnSubmit.textContent;
  btnSubmit.textContent = 'Cadastrando...';
  btnSubmit.disabled = true;

  // Chamar funÃ§Ã£o de cadastro
  const resultado = await cadastrarMembroEquipe(formData);

  // Restaurar botÃ£o
  btnSubmit.textContent = textoOriginal;
  btnSubmit.disabled = false;

  // Mostrar resultado
  if (resultado.sucesso) {
    alert('âœ… Membro cadastrado com sucesso!');
    event.target.reset();
    
    // Fechar modal se estiver usando
    const modal = document.querySelector('.modal');
    if (modal) {
      modal.style.display = 'none';
    }
    
    // Recarregar lista de membros
    if (typeof listarMembros === 'function') {
      listarMembros();
    }
  } else {
    alert('âŒ Erro ao cadastrar: ' + resultado.erro);
  }
});

// ============================================================
// FUNÃ‡ÃƒO PARA VALIDAR CPF
// ============================================================

function validarCPF(cpf) {
  cpf = cpf.replace(/[^\d]/g, '');
  
  if (cpf.length !== 11) return false;
  if (/^(\d)\1{10}$/.test(cpf)) return false;

  let soma = 0;
  for (let i = 0; i < 9; i++) {
    soma += parseInt(cpf.charAt(i)) * (10 - i);
  }
  let resto = 11 - (soma % 11);
  let digito1 = resto === 10 || resto === 11 ? 0 : resto;
  
  if (digito1 !== parseInt(cpf.charAt(9))) return false;

  soma = 0;
  for (let i = 0; i < 10; i++) {
    soma += parseInt(cpf.charAt(i)) * (11 - i);
  }
  resto = 11 - (soma % 11);
  let digito2 = resto === 10 || resto === 11 ? 0 : resto;
  
  return digito2 === parseInt(cpf.charAt(10));
}

// ============================================================
// FUNÃ‡ÃƒO PARA FORMATAR CPF AUTOMATICAMENTE
// ============================================================

function formatarCPF(input) {
  let valor = input.value.replace(/\D/g, '');
  
  if (valor.length <= 11) {
    valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
    valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
    valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
  }
  
  input.value = valor;
}

// Aplicar formataÃ§Ã£o ao campo CPF
document.getElementById('cpf')?.addEventListener('input', function() {
  formatarCPF(this);
});

// Validar CPF ao sair do campo
document.getElementById('cpf')?.addEventListener('blur', function() {
  const cpf = this.value;
  if (cpf && !validarCPF(cpf)) {
    alert('âš ï¸ CPF invÃ¡lido!');
    this.focus();
  }
});

// ============================================================
// FUNÃ‡ÃƒO PARA FORMATAR TELEFONE AUTOMATICAMENTE
// ============================================================

function formatarTelefone(input) {
  let valor = input.value.replace(/\D/g, '');
  
  if (valor.length <= 11) {
    if (valor.length === 11) {
      valor = valor.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    } else if (valor.length === 10) {
      valor = valor.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
    }
  }
  
  input.value = valor;
}

// Aplicar formataÃ§Ã£o aos campos de telefone
document.getElementById('telefone')?.addEventListener('input', function() {
  formatarTelefone(this);
});

document.getElementById('whatsapp')?.addEventListener('input', function() {
  formatarTelefone(this);
});

// ============================================================
// FUNÃ‡ÃƒO PARA LISTAR MEMBROS DA EQUIPE
// ============================================================

async function listarMembros(filtros = {}) {
  try {
    let query = supabase
      .from('membros_equipe')
      .select('*');

    // Aplicar filtros
    if (filtros.status) {
      query = query.eq('status', filtros.status);
    }
    if (filtros.funcao) {
      query = query.eq('funcao', filtros.funcao);
    }
    if (filtros.busca) {
      query = query.or(`nome.ilike.%${filtros.busca}%,cpf.ilike.%${filtros.busca}%`);
    }

    // Ordenar
    query = query.order('nome', { ascending: true });

    const { data, error } = await query;

    if (error) throw error;

    console.log('ğŸ“‹ Membros encontrados:', data.length);
    return data;

  } catch (erro) {
    console.error('âŒ Erro ao listar membros:', erro);
    return [];
  }
}

// ============================================================
// FUNÃ‡ÃƒO PARA ATUALIZAR MEMBRO
// ============================================================

async function atualizarMembro(id, novosDados) {
  try {
    const { data, error } = await supabase
      .from('membros_equipe')
      .update(novosDados)
      .eq('id', id)
      .select();

    if (error) throw error;

    console.log('âœ… Membro atualizado:', data);
    return { sucesso: true, dados: data[0] };

  } catch (erro) {
    console.error('âŒ Erro ao atualizar:', erro);
    return { sucesso: false, erro: erro.message };
  }
}

// ============================================================
// FUNÃ‡ÃƒO PARA INATIVAR MEMBRO (NÃƒO DELETAR)
// ============================================================

async function inativarMembro(id) {
  try {
    const { data, error } = await supabase
      .from('membros_equipe')
      .update({ status: 'inativo' })
      .eq('id', id)
      .select();

    if (error) throw error;

    console.log('âœ… Membro inativado:', data);
    return { sucesso: true, dados: data[0] };

  } catch (erro) {
    console.error('âŒ Erro ao inativar:', erro);
    return { sucesso: false, erro: erro.message };
  }
}

// ============================================================
// FUNÃ‡ÃƒO PARA BUSCAR MEMBRO POR CPF
// ============================================================

async function buscarPorCPF(cpf) {
  try {
    const cpfLimpo = cpf.replace(/[^\d]/g, '');
    
    const { data, error } = await supabase
      .from('membros_equipe')
      .select('*')
      .eq('cpf', cpf)
      .single();

    if (error && error.code !== 'PGRST116') throw error;

    return data;

  } catch (erro) {
    console.error('âŒ Erro ao buscar por CPF:', erro);
    return null;
  }
}

// ============================================================
// FUNÃ‡ÃƒO PARA OBTER ESTATÃSTICAS
// ============================================================

async function obterEstatisticas() {
  try {
    const { data, error } = await supabase
      .from('membros_equipe')
      .select('status, funcao');

    if (error) throw error;

    const stats = {
      total: data.length,
      ativos: data.filter(m => m.status === 'ativo').length,
      inativos: data.filter(m => m.status === 'inativo').length,
      porFuncao: {}
    };

    data.forEach(membro => {
      if (!stats.porFuncao[membro.funcao]) {
        stats.porFuncao[membro.funcao] = 0;
      }
      stats.porFuncao[membro.funcao]++;
    });

    return stats;

  } catch (erro) {
    console.error('âŒ Erro ao obter estatÃ­sticas:', erro);
    return null;
  }
}

// ============================================================
// EXPORTAR FUNÃ‡Ã•ES (se estiver usando mÃ³dulos)
// ============================================================

if (typeof module !== 'undefined' && module.exports) {
  module.exports = {
    cadastrarMembroEquipe,
    listarMembros,
    atualizarMembro,
    inativarMembro,
    buscarPorCPF,
    obterEstatisticas,
    validarCPF,
    formatarCPF,
    formatarTelefone
  };
}

// ============================================================
// CONSOLE LOG DE AJUDA
// ============================================================

console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  SISTEMA DE CADASTRO DE MEMBROS          â•‘
â•‘  FunÃ§Ãµes disponÃ­veis:                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ cadastrarMembroEquipe(formData)
ğŸ“‹ listarMembros(filtros)
âœï¸  atualizarMembro(id, novosDados)
ğŸš« inativarMembro(id)
ğŸ” buscarPorCPF(cpf)
ğŸ“Š obterEstatisticas()
âœ… validarCPF(cpf)

Use essas funÃ§Ãµes para gerenciar a equipe!
`);